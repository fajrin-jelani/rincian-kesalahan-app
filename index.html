<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Kesalahan Preparasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    :root {
      --primary: #4b5563;
      --primary-light: #6b7684;
      --accent: #6b7684;
      --accent-dark: #5a6470;
      --success: #6b7684;
      --warning: #8b95a5;
      --danger: #8b95a5;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #d1d7e0;
      --text-primary: #2d3748;
      --text-secondary: #5a6470;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
  <script src="https://cdn.tailwindcss.com/3.4.17" type="text/javascript"></script>
 </head>
 <body class="h-full bg-slate-50 overflow-auto" style="background-color: var(--light-bg)"><!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4" style="background-color: var(--card-bg)">
    <div class="text-center mb-6">
     <div class="text-5xl mb-4">
      ğŸ”
     </div>
     <h1 class="text-2xl font-bold mb-2" style="color: var(--text-primary)">Masuk ke Aplikasi</h1>
     <p style="color: var(--text-secondary)">Masukkan kode keamanan untuk melanjutkan</p>
    </div>
    <form id="login-form" class="space-y-4">
     <div><input type="password" id="login-code-input" placeholder="Masukkan kode 4 digit" maxlength="4" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:border-0 transition-all text-center tracking-widest font-bold" style="border-color: var(--border); focus:ring-color: var(--accent); font-size: 14px;" autocomplete="off">
     </div>
     <div id="login-error" class="text-red-500 text-sm hidden text-center">
      ï¿½ï¿½ï¿½ Kode salah! Silakan coba lagi.
     </div><button type="submit" class="w-full px-6 py-3 text-white font-bold rounded-xl transition-all shadow-md hover:shadow-lg" style="background-color: var(--accent)"> ğŸ”“ Masuk </button>
    </form>
    <div class="mt-6 rounded-xl p-4 text-sm" style="background-color: var(--light-bg); border: 1px solid var(--border); color: var(--accent)">
     <p class="font-medium mb-2">ğŸ’¡ Petunjuk</p>
     <p>Gunakan kode keamanan untuk masuk ke aplikasi</p>
    </div>
   </div>
  </div>
  <div class="app-wrapper h-full w-full min-h-full hidden">
   <div class="max-w-6xl mx-auto p-4 md:p-6"><!-- Header with Settings Button -->
    <div class="mb-6">
     <div class="flex justify-between items-center gap-4 mb-4">
      <h1 id="app-title" class="text-2xl md:text-3xl font-bold text-slate-800">ğŸ“‹ Daftar Kesalahan Preparasi</h1><button id="settings-btn" class="px-6 py-3 bg-gradient-to-r from-slate-500 to-slate-600 hover:from-slate-600 hover:to-slate-700 text-white font-medium rounded-2xl transition-all shadow-md hover:shadow-lg flex items-center gap-2 whitespace-nowrap"> âš™ï¸ Pengaturan </button>
     </div>
     <div class="bg-gradient-to-r from-slate-600 to-slate-700 rounded-2xl p-6 shadow-lg">
      <p class="text-slate-200 text-center text-sm">ï¿½ï¿½ï¿½ Data tersimpan di Canva Sheet &amp; Google Sheets</p>
     </div>
    </div><!-- Form Section -->
    <div class="bg-white rounded-2xl shadow-md p-6 mb-6">
     <h2 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">âœï¸</span> Tambah Data Baru</h2>
     <form id="error-form" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><!-- Tanggal -->
       <div><label for="tanggal" class="block text-sm font-medium text-slate-600 mb-1">Tanggal</label> <input type="date" id="tanggal" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
       </div><!-- NIK Dropdown -->
       <div><label for="nik-select" class="block text-sm font-medium text-slate-600 mb-1">NIK</label> <select id="nik-select" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"> <option value="">-- Pilih NIK --</option> </select>
       </div>
      </div><!-- Nama dan NIK Manual bersampingan -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><!-- Nama -->
       <div><label for="nama" class="block text-sm font-medium text-slate-600 mb-1">Nama</label> <input type="text" id="nama" required placeholder="Nama otomatis atau tulis manual" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
       </div><!-- NIK Manual -->
       <div><label for="nik-manual" class="block text-sm font-medium text-slate-600 mb-1">NIK Manual (Opsional)</label> <input type="text" id="nik-manual" placeholder="Tulis NIK manual jika diperlukan" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
       </div>
      </div><!-- Kesalahan Tulis -->
      <div><label for="kesalahan-tulis" class="block text-sm font-medium text-slate-600 mb-1">Kesalahan Tulis</label> <textarea id="kesalahan-tulis" rows="2" placeholder="Tuliskan keterangan kesalahan tulis..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all resize-none"></textarea>
      </div><!-- Lain-lain -->
      <div><label for="lain-lain" class="block text-sm font-medium text-slate-600 mb-1">Lain-lain</label> <textarea id="lain-lain" rows="2" placeholder="Tuliskan keterangan lain-lain..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all resize-none"></textarea>
      </div><!-- Keterangan -->
      <div><label for="keterangan" class="block text-sm font-medium text-slate-600 mb-1">Keterangan</label> <textarea id="keterangan" rows="2" placeholder="Tuliskan keterangan tambahan..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all resize-none"></textarea>
      </div><!-- Submit Button -->
      <div class="flex justify-end"><button type="submit" id="submit-btn" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl transition-all shadow-md hover:shadow-lg flex items-center gap-2"> <span>ï¿½ï¿½</span> Simpan Data </button>
      </div>
     </form>
    </div><!-- Delete Employee Modal -->
    <div id="delete-employee-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
     <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
      <h3 class="text-lg font-semibold text-slate-800 mb-2">ï¿½ï¿½ï¿½ï¸ Hapus Karyawan</h3>
      <p id="delete-employee-msg" class="text-slate-600 mb-4"></p>
      <div class="flex gap-3 justify-start"><button type="button" id="confirm-delete-employee" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl transition-all"> Ya, Hapus </button> <button type="button" id="cancel-delete-employee" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-xl transition-all"> Batal </button>
      </div>
     </div>
    </div><!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-start z-50 p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-96 max-h-[90vh] overflow-y-auto custom-scrollbar mt-4"><!-- Header -->
      <div class="sticky top-0 bg-gradient-to-r from-orange-500 to-orange-600 p-6 flex items-center justify-between">
       <h2 class="text-xl font-bold text-white flex items-center gap-2"><span>âš™ï¸</span> Pengaturan Karyawan</h2><button type="button" id="close-settings-modal" class="text-white hover:bg-orange-700 rounded-lg p-2 transition-all"> ï¿½ï¿½ï¿½ </button>
      </div><!-- Modal Content -->
      <div class="p-6 space-y-6"><!-- Add New Employee Section -->
       <div>
        <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">ï¿½ï¿½ï¿½</span> Tambah Karyawan Baru</h3>
        <form id="employee-form" class="space-y-3">
         <div><label for="new-nik" class="block text-sm font-medium text-slate-600 mb-1">NIK</label> <input type="text" id="new-nik" placeholder="Contoh: 1234.01.25" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
         </div>
         <div><label for="new-nama" class="block text-sm font-medium text-slate-600 mb-1">Nama Karyawan</label> <input type="text" id="new-nama" placeholder="Nama lengkap karyawan" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
         </div><button type="submit" id="add-employee-btn" class="w-full px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-xl transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"> â• Tambah Karyawan </button>
        </form>
       </div><!-- Divider -->
       <div class="border-t border-slate-200"></div><!-- Manage Employees Section -->
       <div>
        <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2"><span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">ğŸ“‹</span> Daftar Semua Karyawan</h3><!-- Search Input -->
        <div class="mb-4"><input type="text" id="search-employees" placeholder="ğŸ” Cari nama karyawan..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
        </div>
        <div id="employees-list-container" class="max-h-96 overflow-y-auto custom-scrollbar space-y-2 border border-slate-200 rounded-xl p-4 bg-slate-50">
         <div id="employees-list" class="space-y-2"><!-- Employees akan ditampilkan di sini -->
         </div>
         <div id="no-employees" class="text-center py-8 text-slate-400">
          <p class="text-sm">ğŸ“­ Tidak ada karyawan</p>
         </div>
        </div>
       </div><!-- Footer -->
       <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-700">
        <p class="font-medium mb-2">ï¿½ï¿½ï¿½ Informasi</p>
        <ul class="space-y-1 ml-4">
         <li>âœ“ Semua karyawan dapat dihapus sesuai kebutuhan</li>
         <li>âœ“ Karyawan bawaan (ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½) dan manual (âœï¸) sama-sama dapat dihapus</li>
         <li>âœ“ Perubahan akan tersimpan secara otomatis</li>
        </ul>
       </div>
      </div><!-- Footer Buttons -->
      <div class="sticky bottom-0 bg-slate-50 border-t border-slate-200 p-6 flex justify-end"><button type="button" id="close-settings-btn" class="px-6 py-2.5 bg-slate-300 hover:bg-slate-400 text-slate-800 font-medium rounded-xl transition-all"> Tutup </button>
      </div>
     </div>
    </div><!-- Data Table Section -->
    <div class="bg-white rounded-2xl shadow-md p-6">
     <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <h2 class="text-lg font-semibold text-slate-700 flex items-center gap-2"><span class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">ğŸ“Š</span> Data Kesalahan <span id="data-count" class="text-sm font-normal text-slate-500">(0 data)</span></h2>
      <div class="flex gap-2 flex-wrap w-full sm:w-auto"><button type="button" id="refresh-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-xl transition-all text-sm flex items-center gap-2 whitespace-nowrap"> ï¿½ï¿½ï¿½ï¿½ï¿½ Refresh Data </button> <button type="button" id="reset-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl transition-all text-sm flex items-center gap-2 whitespace-nowrap"> ğŸ—‘ï¸ Reset Semua Data </button> <button type="button" id="send-btn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-xl transition-all text-sm flex items-center gap-2 whitespace-nowrap"> ï¿½ï¿½ Kirim ke Google Sheets </button>
      </div>
     </div><!-- Security Code Modal -->
     <div id="security-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
       <h3 class="text-lg font-semibold text-slate-800 mb-2">ğŸ” Verifikasi Kode Keamanan</h3>
       <p class="text-slate-600 mb-4">Masukkan kode keamanan untuk melanjutkan operasi reset/hapus data.</p><input type="password" id="security-code-input" placeholder="Masukkan kode 4 digit" maxlength="4" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all text-center text-2xl tracking-widest mb-4">
       <div id="security-error" class="text-red-500 text-sm mb-4 hidden">
        âŒ Kode salah! Silakan coba lagi.
       </div>
       <div class="flex gap-3 justify-end"><button type="button" id="verify-security" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl transition-all"> Ya, Hapus </button> <button type="button" id="cancel-security" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-xl transition-all"> Batal </button>
       </div>
      </div>
     </div><!-- Confirmation Modal -->
     <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
       <h3 class="text-lg font-semibold text-slate-800 mb-2">ï¿½ï¿½ï¸ Konfirmasi Reset</h3>
       <p class="text-slate-600 mb-4">Apakah Anda yakin ingin menghapus SEMUA data kesalahan? Tindakan ini tidak dapat dibatalkan.</p>
       <div class="flex gap-3 justify-end"><button type="button" id="cancel-reset" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-xl transition-all"> Batal </button> <button type="button" id="confirm-reset" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl transition-all"> Ya, Hapus Semua </button>
       </div>
      </div>
     </div><!-- Delete Item Confirmation -->
     <div id="delete-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
       <h3 class="text-lg font-semibold text-slate-800 mb-2">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Hapus Data</h3>
       <p class="text-slate-600 mb-4">Apakah Anda yakin ingin menghapus data ini?</p>
       <div class="flex gap-3 justify-end"><button type="button" id="cancel-delete-item" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-xl transition-all"> Batal </button> <button type="button" id="confirm-delete-item" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl transition-all"> Ya, Hapus </button>
       </div>
      </div>
     </div><!-- Send to Spreadsheet Confirmation -->
     <div id="send-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
       <h3 class="text-lg font-semibold text-slate-800 mb-2">ï¿½ï¿½ Kirim ke Google Sheets</h3>
       <p id="send-modal-msg" class="text-slate-600 mb-4"></p>
       <div class="flex gap-3 justify-end"><button type="button" id="cancel-send" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-xl transition-all"> Batal </button> <button type="button" id="confirm-send" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-xl transition-all"> Ya, Buka Google Sheets </button>
       </div>
      </div>
     </div><!-- Edit Data Modal -->
     <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar"><!-- Header -->
       <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-blue-600 p-6 flex items-center justify-between">
        <h2 class="text-xl font-bold text-white flex items-center gap-2"><span>ï¿½ï¿½ï¿½ï¿½ï¿½ï¸</span> Edit Data Kesalahan</h2><button type="button" id="close-edit-modal" class="text-white hover:bg-blue-700 rounded-lg p-2 transition-all"> âœ• </button>
       </div><!-- Modal Content -->
       <div class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><!-- Tanggal -->
         <div><label for="edit-tanggal" class="block text-sm font-medium text-slate-600 mb-1">Tanggal</label> <input type="date" id="edit-tanggal" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
         </div><!-- NIK -->
         <div><label for="edit-nik" class="block text-sm font-medium text-slate-600 mb-1">NIK</label> <input type="text" id="edit-nik" placeholder="NIK" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
         </div><!-- Nama -->
         <div><label for="edit-nama" class="block text-sm font-medium text-slate-600 mb-1">Nama</label> <input type="text" id="edit-nama" placeholder="Nama" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
         </div>
        </div><!-- Kesalahan Tulis -->
        <div><label for="edit-kesalahan-tulis" class="block text-sm font-medium text-slate-600 mb-1">Kesalahan Tulis</label> <textarea id="edit-kesalahan-tulis" rows="2" placeholder="Tuliskan keterangan kesalahan tulis..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"></textarea>
        </div><!-- Lain-lain -->
        <div><label for="edit-lain-lain" class="block text-sm font-medium text-slate-600 mb-1">Lain-lain</label> <textarea id="edit-lain-lain" rows="2" placeholder="Tuliskan keterangan lain-lain..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"></textarea>
        </div><!-- Keterangan -->
        <div><label for="edit-keterangan" class="block text-sm font-medium text-slate-600 mb-1">Keterangan</label> <textarea id="edit-keterangan" rows="2" placeholder="Tuliskan keterangan tambahan..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"></textarea>
        </div>
       </div><!-- Footer Buttons -->
       <div class="sticky bottom-0 bg-slate-50 border-t border-slate-200 p-6 flex gap-3 justify-end"><button type="button" id="cancel-edit-btn" class="px-6 py-2.5 bg-slate-300 hover:bg-slate-400 text-slate-800 font-medium rounded-xl transition-all"> Batal </button> <button type="button" id="save-edit-btn" class="px-6 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-xl transition-all"> ğŸ’¾ Simpan Perubahan </button>
       </div>
      </div>
     </div><!-- Table Container -->
     <div class="overflow-x-auto custom-scrollbar rounded-xl border border-slate-200">
      <table class="w-full min-w-[800px]">
       <thead class="bg-slate-50">
        <tr>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">No</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tanggal</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">NIK</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Nama</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Kesalahan Tulis</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Lain-lain</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Keterangan</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Aksi</th>
        </tr>
       </thead>
       <tbody id="data-table-body" class="divide-y divide-slate-100">
        <tr id="empty-state">
         <td colspan="8" class="px-4 py-12 text-center text-slate-400">
          <div class="flex flex-col items-center gap-2"><span class="text-4xl">ğŸ“­</span>
           <p>Belum ada data kesalahan</p>
          </div></td>
        </tr>
       </tbody>
      </table>
     </div><!-- Loading State -->
     <div id="loading-state" class="hidden py-8 text-center">
      <div class="inline-flex items-center gap-2 text-slate-500">
       <svg class="animate-spin h-5 w-5" viewbox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
       </svg><span>Memproses...</span>
      </div>
     </div>
    </div><!-- Footer -->
    <footer class="mt-6 text-center text-sm text-slate-400 pb-4">
     <p>ğŸ’¡ Data tersimpan di Canva Sheet &amp; Google Sheets secara otomatis</p>
    </footer>
   </div>
  </div>
  <script>
    // Google Sheets URL
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycby5U1DtRKcSIQLQRhheDentnF-cHByoL8T3LMIUuwbAkdMsxGbFM0qUqrz7Kvi0Fci0/exec';
    const SECURITY_CODE = '8686';
    
    // Login handler
    const loginForm = document.getElementById('login-form');
    const loginCodeInput = document.getElementById('login-code-input');
    const loginError = document.getElementById('login-error');
    const loginModal = document.getElementById('login-modal');
    const appWrapper = document.querySelector('.app-wrapper');
    
    // Check if already logged in
    function isLoggedIn() {
      return sessionStorage.getItem('app-logged-in') === 'true';
    }
    
    // Set logged in state
    function setLoggedIn() {
      sessionStorage.setItem('app-logged-in', 'true');
    }
    
    // Initialize login
    function initLogin() {
      if (isLoggedIn()) {
        loginModal.classList.add('hidden');
        appWrapper.classList.remove('hidden');
      } else {
        loginCodeInput.focus();
      }
    }
    
    // Handle login form submission
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const code = loginCodeInput.value;
      
      if (code === SECURITY_CODE) {
        loginError.classList.add('hidden');
        setLoggedIn();
        
        // Show success animation
        loginForm.style.opacity = '0.5';
        
        setTimeout(() => {
          loginModal.classList.add('hidden');
          appWrapper.classList.remove('hidden');
          loginForm.style.opacity = '1';
        }, 500);
      } else {
        loginError.classList.remove('hidden');
        loginCodeInput.value = '';
        loginCodeInput.focus();
      }
    });
    
    // Allow Enter key to login
    loginCodeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loginForm.dispatchEvent(new Event('submit'));
      }
    });
    
    // Track uploaded data
    let uploadedDataIds = new Set();
    let pendingAction = null;

    // Default employee list
    const defaultEmployees = [
      { nik: "4826.01.25", nama: "Aidil" },
      { nik: "3438.10.23", nama: "Budi Maulana" },
      { nik: "5188.06.25", nama: "Abdillah Al Husain" },
      { nik: "3136.06.23", nama: "Raihan" },
      { nik: "4321.07.24", nama: "Reksy Moningka" },
      { nik: "4300.06.24", nama: "Muhammat Alamin" },
      { nik: "3243.07.23", nama: "Muhammad Fajriansyah" },
      { nik: "4147.05.24", nama: "LA SURI" },
      { nik: "3210.07.23", nama: "Yugo Kawiwitan" },
      { nik: "4299.06.24", nama: "Bayu Prasati Wahyu" },
      { nik: "4873.02.25", nama: "Agus Maulana" },
      { nik: "4365.07.24", nama: "Junaidi" },
      { nik: "3209.07.23", nama: "M Irfanuddin" },
      { nik: "4323.07.24", nama: "Timotius hatu" },
      { nik: "3244.07.23", nama: "Wahyu Hidayat" },
      { nik: "3826.02.24", nama: "Maksimus jehan" },
      { nik: "4367.07.24", nama: "wildan Mashobir" },
      { nik: "4366.07.24", nama: "Rahmat" },
      { nik: "3908.03.24", nama: "Ahmad Muliansyah" },
      { nik: "2611.08.22", nama: "Rizal Wandi" },
      { nik: "2834.01.23", nama: "Fani Kurniawan" }
    ];

    // App state
    let employees = [...defaultEmployees];
    let deletedDefaultEmployees = [];
    let errorData = [];
    let itemToDelete = null;
    let employeeToDelete = null;

    // Default config
    const defaultConfig = {
      app_title: "ï¿½ï¿½ Daftar Kesalahan Preparasi"
    };

    // Load deleted default employees from localStorage
    function loadDeletedEmployees() {
      try {
        const saved = localStorage.getItem('deleted_default_employees');
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.error('Failed to load deleted employees');
      }
      return [];
    }

    // Load deleted default employees from localStorage
    function loadDeletedEmployees() {
      try {
        const saved = localStorage.getItem('deleted_default_employees');
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.error('Failed to load deleted employees');
      }
      return [];
    }

    // Save deleted default employees to localStorage
    function saveDeletedEmployees(deleted) {
      localStorage.setItem('deleted_default_employees', JSON.stringify(deleted));
    }

    // Add search event listener
    document.getElementById('search-employees').addEventListener('input', function(e) {
      const searchTerm = e.target.value;
      filterAndRenderEmployees(searchTerm);
    });

    // Filter and render employees list based on search
    function filterAndRenderEmployees(searchTerm = '') {
      const listContainer = document.getElementById('employees-list');
      const noEmployees = document.getElementById('no-employees');
      
      if (employees.length === 0) {
        listContainer.innerHTML = '';
        noEmployees.classList.remove('hidden');
        noEmployees.innerHTML = '<p class="text-sm">ğŸ“­ Tidak ada karyawan</p>';
        return;
      }
      
      // Sort alphabetically A-Z by nama
      let sortedEmployees = [...employees].sort((a, b) => 
        a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' })
      );
      
      // Filter berdasarkan search term
      if (searchTerm.trim()) {
        const lowerSearch = searchTerm.toLowerCase().trim();
        sortedEmployees = sortedEmployees.filter(emp => 
          emp.nama.toLowerCase().includes(lowerSearch) || 
          emp.nik.toLowerCase().includes(lowerSearch)
        );
      }
      
      if (sortedEmployees.length === 0) {
        listContainer.innerHTML = '';
        noEmployees.classList.remove('hidden');
        noEmployees.innerHTML = `<p class="text-sm">ğŸ” Tidak ada karyawan dengan nama "${searchTerm}"</p>`;
        return;
      }
      
      noEmployees.classList.add('hidden');
      
      listContainer.innerHTML = sortedEmployees.map(emp => {
        const isDefault = defaultEmployees.find(def => def.nik === emp.nik);
        return `
          <div class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-slate-50 transition-colors border border-slate-200">
            <div class="flex-1">
              <p class="font-medium text-slate-700">${emp.nama}</p>
              <p class="text-sm text-slate-500">${emp.nik}</p>
              ${isDefault ? '<p class="text-xs text-blue-600 font-medium mt-1">ğŸ“Œ Karyawan Bawaan</p>' : '<p class="text-xs text-orange-600 font-medium mt-1">ï¿½ï¿½ï¸ Karyawan Manual</p>'}
            </div>
            <button type="button" class="delete-employee-btn px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-600 text-xs font-medium rounded-lg transition-all" data-nik="${emp.nik}">
              ğŸ—‘ï¸
            </button>
          </div>
        `;
      }).join('');
    }

    // Render all employees list (without search)
    function renderEmployeesList() {
      filterAndRenderEmployees();
    }
    function populateNikDropdown() {
      const select = document.getElementById('nik-select');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">-- Pilih NIK --</option><option value="manual">âœï¿½ï¿½ï¿½ Tulis Manual</option>';
      
      // Urutkan employees berdasarkan nama A-Z
      const sortedEmployees = [...employees].sort((a, b) => 
        a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' })
      );
      
      sortedEmployees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.nik;
        option.textContent = `${emp.nik} - ${emp.nama}`;
        select.appendChild(option);
      });
      
      // Restore nilai sebelumnya jika masih ada
      if (currentValue && [...select.options].find(o => o.value === currentValue)) {
        select.value = currentValue;
      }
    }

    // Render all employees list
    function renderEmployeesList() {
      const listContainer = document.getElementById('employees-list');
      const noEmployees = document.getElementById('no-employees');
      
      if (employees.length === 0) {
        listContainer.innerHTML = '';
        noEmployees.classList.remove('hidden');
        return;
      }
      
      noEmployees.classList.add('hidden');
      
      // Sort alphabetically A-Z by nama
      const sortedEmployees = [...employees].sort((a, b) => 
        a.nama.localeCompare(b.nama, 'id', { sensitivity: 'base' })
      );
      
      listContainer.innerHTML = sortedEmployees.map(emp => {
        const isDefault = defaultEmployees.find(def => def.nik === emp.nik);
        return `
          <div class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-slate-50 transition-colors border border-slate-200">
            <div class="flex-1">
              <p class="font-medium text-slate-700">${emp.nama}</p>
              <p class="text-sm text-slate-500">${emp.nik}</p>
              ${isDefault ? '<p class="text-xs text-blue-600 font-medium mt-1">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Karyawan Bawaan</p>' : '<p class="text-xs text-orange-600 font-medium mt-1">âœï¸ Karyawan Manual</p>'}
            </div>
            <button type="button" class="delete-employee-btn px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-600 text-xs font-medium rounded-lg transition-all" data-nik="${emp.nik}">
              ğŸ—‘ï¿½ï¿½ï¿½
            </button>
          </div>
        `;
      }).join('');
    }

    // Handle NIK selection
    document.getElementById('nik-select').addEventListener('change', function() {
      const namaInput = document.getElementById('nama');
      if (this.value === 'manual') {
        namaInput.value = '';
        namaInput.placeholder = 'Tulis nama manual';
        namaInput.focus();
      } else if (this.value) {
        const emp = employees.find(e => e.nik === this.value);
        if (emp) {
          namaInput.value = emp.nama;
        }
      } else {
        namaInput.value = '';
        namaInput.placeholder = 'Nama otomatis atau tulis manual';
      }
    });



    // Format date for display
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

    // Get sorted data by date (earliest first)
    function getSortedData(data = errorData) {
      return [...data].sort((a, b) => {
        const dateA = new Date(a.tanggal);
        const dateB = new Date(b.tanggal);
        return dateA - dateB;
      });
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('data-table-body');
      const emptyState = document.getElementById('empty-state');
      const countEl = document.getElementById('data-count');
      
      const sortedData = getSortedData();
      
      countEl.textContent = `(${sortedData.length} data)`;
      
      if (sortedData.length === 0) {
        tbody.innerHTML = '';
        tbody.appendChild(createEmptyState());
        return;
      }
      
      const existingRows = new Map();
      tbody.querySelectorAll('tr[data-id]').forEach(row => {
        existingRows.set(row.dataset.id, row);
      });
      
      const empty = tbody.querySelector('#empty-state');
      if (empty) empty.remove();
      
      sortedData.forEach((item, index) => {
        const existingRow = existingRows.get(item.__backendId);
        
        if (existingRow) {
          updateRow(existingRow, item, index);
          existingRows.delete(item.__backendId);
        } else {
          const newRow = createRow(item, index);
          tbody.appendChild(newRow);
        }
      });
      
      existingRows.forEach(row => row.remove());
      
      sortedData.forEach((item, index) => {
        const row = tbody.querySelector(`tr[data-id="${item.__backendId}"]`);
        if (row) {
          row.querySelector('td:first-child').textContent = index + 1;
          tbody.appendChild(row);
        }
      });
    }

    function createEmptyState() {
      const tr = document.createElement('tr');
      tr.id = 'empty-state';
      tr.innerHTML = `
        <td colspan="8" class="px-4 py-12 text-center text-slate-400">
          <div class="flex flex-col items-center gap-2">
            <span class="text-4xl">ğŸ“­</span>
            <p>Belum ada data kesalahan</p>
          </div>
        </td>
      `;
      return tr;
    }

    function createRow(item, index) {
      const tr = document.createElement('tr');
      tr.dataset.id = item.__backendId;
      tr.className = 'hover:bg-slate-50 transition-colors';
      tr.innerHTML = `
        <td class="px-4 py-3 text-sm text-slate-600">${index + 1}</td>
        <td class="px-4 py-3 text-sm text-slate-700 font-medium">${formatDate(item.tanggal)}</td>
        <td class="px-4 py-3 text-sm text-slate-600">${item.nik || '-'}</td>
        <td class="px-4 py-3 text-sm text-slate-700 font-medium">${item.nama || '-'}</td>
        <td class="px-4 py-3 text-sm text-slate-600 max-w-[150px] truncate" title="${item.kesalahan_tulis || ''}">${item.kesalahan_tulis || '-'}</td>
        <td class="px-4 py-3 text-sm text-slate-600 max-w-[150px] truncate" title="${item.lain_lain || ''}">${item.lain_lain || '-'}</td>
        <td class="px-4 py-3 text-sm text-slate-600 max-w-[150px] truncate" title="${item.keterangan || ''}">${item.keterangan || '-'}</td>
        <td class="px-4 py-3 flex gap-2">
          <button type="button" class="edit-btn px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-600 text-xs font-medium rounded-lg transition-all" data-id="${item.__backendId}">
            âœï¸ Edit
          </button>
          <button type="button" class="delete-btn px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-600 text-xs font-medium rounded-lg transition-all" data-id="${item.__backendId}">
            ğŸ—‘ï¸ Hapus
          </button>
        </td>
      `;
      return tr;
    }

    function updateRow(row, item, index) {
      const cells = row.querySelectorAll('td');
      cells[0].textContent = index + 1;
      cells[1].textContent = formatDate(item.tanggal);
      cells[2].textContent = item.nik || '-';
      cells[3].textContent = item.nama || '-';
      cells[4].textContent = item.kesalahan_tulis || '-';
      cells[4].title = item.kesalahan_tulis || '';
      cells[5].textContent = item.lain_lain || '-';
      cells[5].title = item.lain_lain || '';
      cells[6].textContent = item.keterangan || '-';
      cells[6].title = item.keterangan || '';
    }

    // Form submission
    document.getElementById('error-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const nikSelect = document.getElementById('nik-select');
      const nikManual = document.getElementById('nik-manual').value.trim();
      
      // Gunakan NIK manual jika diisi, jika tidak gunakan dari dropdown
      let nik = nikManual || (nikSelect.value === 'manual' ? '' : nikSelect.value);
      
      const newRecord = {
        id: Date.now().toString(),
        tanggal: document.getElementById('tanggal').value,
        nik: nik,
        nama: document.getElementById('nama').value,
        kesalahan_tulis: document.getElementById('kesalahan-tulis').value,
        lain_lain: document.getElementById('lain-lain').value,
        keterangan: document.getElementById('keterangan').value,
        created_at: new Date().toISOString()
      };
      
      if (errorData.length >= 999) {
        showToast('Batas maksimum 999 data tercapai. Hapus beberapa data terlebih dahulu.', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="animate-spin">ğŸ’«</span> Menyimpan...';
      
      const result = await window.dataSdk.create(newRecord);
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>ğŸ’¾</span> Simpan Data';
      
      if (result.isOk) {
        this.reset();
        document.getElementById('tanggal').valueAsDate = new Date();
        document.getElementById('nik-manual').value = '';
        showToast('ï¿½ï¿½ï¿½ Data berhasil disimpan!', 'success');
      } else {
        showToast('Gagal menyimpan data. Silakan coba lagi.', 'error');
      }
    });

    // Save custom employees to localStorage
    function saveCustomEmployees() {
      const customEmps = employees.filter(emp => 
        !defaultEmployees.find(def => def.nik === emp.nik)
      );
      localStorage.setItem('custom_employees', JSON.stringify(customEmps));
    }

    // Load custom employees from localStorage
    function loadCustomEmployees() {
      try {
        const saved = localStorage.getItem('custom_employees');
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.error('Failed to load custom employees');
      }
      return [];
    }

    // Add employee form
    document.getElementById('employee-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const newNik = document.getElementById('new-nik').value.trim();
      const newNama = document.getElementById('new-nama').value.trim();
      
      if (!newNik || !newNama) {
        showToast('NIK dan Nama harus diisi!', 'error');
        return;
      }
      
      // Cek apakah sudah ada
      const exists = employees.find(emp => emp.nik === newNik);
      if (exists) {
        showToast('NIK ini sudah ada!', 'error');
        return;
      }
      
      const addBtn = document.getElementById('add-employee-btn');
      addBtn.disabled = true;
      addBtn.innerHTML = '<span class="animate-spin">ğŸ’«</span> Menambah...';
      
      // Tambah ke memory langsung (tanpa simpan ke Canva Sheet)
      employees.push({ nik: newNik, nama: newNama });
      saveCustomEmployees();
      
      // Tunggu sebentar agar perubahan terlihat
      setTimeout(() => {
        document.getElementById('new-nik').value = '';
        document.getElementById('new-nama').value = '';
        document.getElementById('new-nik').focus();
        
        // Update UI
        populateNikDropdown();
        renderEmployeesList();
        
        addBtn.disabled = false;
        addBtn.innerHTML = 'â• Tambah Karyawan';
        
        showToast(`âœ… Karyawan ${newNama} berhasil ditambahkan!`, 'success');
      }, 100);
    });

    // Settings button event listeners
    document.getElementById('settings-btn').addEventListener('click', function() {
      document.getElementById('settings-modal').classList.remove('hidden');
    });

    document.getElementById('close-settings-modal').addEventListener('click', function() {
      document.getElementById('settings-modal').classList.add('hidden');
    });

    document.getElementById('close-settings-btn').addEventListener('click', function() {
      document.getElementById('settings-modal').classList.add('hidden');
    });

    document.getElementById('settings-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.add('hidden');
      }
    });

    // Delete employee event listener dengan event delegation
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-employee-btn')) {
        const nik = e.target.dataset.nik;
        employeeToDelete = employees.find(emp => emp.nik === nik);
        if (employeeToDelete) {
          document.getElementById('delete-employee-msg').textContent = 
            `Hapus karyawan "${employeeToDelete.nama}" (${employeeToDelete.nik})?`;
          document.getElementById('delete-employee-modal').classList.remove('hidden');
        }
      }
    });

    document.getElementById('cancel-delete-employee').addEventListener('click', function() {
      document.getElementById('delete-employee-modal').classList.add('hidden');
      employeeToDelete = null;
    });

    document.getElementById('confirm-delete-employee').addEventListener('click', function() {
      if (!employeeToDelete) return;
      
      showToast(`ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Menghapus karyawan ${employeeToDelete.nama}...`, 'success');
      
      employees = employees.filter(emp => emp.nik !== employeeToDelete.nik);
      
      const isDefault = defaultEmployees.find(def => def.nik === employeeToDelete.nik);
      if (isDefault) {
        deletedDefaultEmployees.push(employeeToDelete.nik);
        saveDeletedEmployees(deletedDefaultEmployees);
      }
      
      saveCustomEmployees();
      populateNikDropdown();
      renderEmployeesList();
      
      document.getElementById('delete-employee-modal').classList.add('hidden');
      employeeToDelete = null;
    });

    // Edit and Delete single item
    let itemToEdit = null;
    document.getElementById('data-table-body').addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-btn')) {
        const id = e.target.dataset.id;
        itemToEdit = errorData.find(item => item.__backendId === id);
        if (itemToEdit) {
          pendingAction = 'edit-item';
          document.getElementById('security-code-input').value = '';
          document.getElementById('security-error').classList.add('hidden');
          document.getElementById('security-modal').classList.remove('hidden');
        }
      } else if (e.target.classList.contains('delete-btn')) {
        const id = e.target.dataset.id;
        itemToDelete = errorData.find(item => item.__backendId === id);
        if (itemToDelete) {
          pendingAction = 'delete-item';
          document.getElementById('security-code-input').value = '';
          document.getElementById('security-error').classList.add('hidden');
          document.getElementById('security-modal').classList.remove('hidden');
        }
      }
    });

    document.getElementById('cancel-delete-item').addEventListener('click', function() {
      document.getElementById('delete-item-modal').classList.add('hidden');
      itemToDelete = null;
    });

    // Edit modal handlers
    document.getElementById('close-edit-modal').addEventListener('click', function() {
      document.getElementById('edit-modal').classList.add('hidden');
      itemToEdit = null;
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', function() {
      document.getElementById('edit-modal').classList.add('hidden');
      itemToEdit = null;
    });

    document.getElementById('edit-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.add('hidden');
        itemToEdit = null;
      }
    });

    document.getElementById('confirm-delete-item').addEventListener('click', async function() {
      if (!itemToDelete) return;
      
      this.disabled = true;
      this.textContent = 'Menghapus...';
      
      // Delete dari Canva Sheet
      const result = await window.dataSdk.delete(itemToDelete);
      
      if (result.isOk) {
        uploadedDataIds.delete(itemToDelete.__backendId);
        
        // Otomatis hapus dari Google Sheets juga
        try {
          await deleteFromGoogleSheets([{
            backendId: itemToDelete.__backendId,
            tanggal: itemToDelete.tanggal,
            nik: itemToDelete.nik || '-',
            nama: itemToDelete.nama || '-',
            kesalahan_tulis: itemToDelete.kesalahan_tulis || '-',
            lain_lain: itemToDelete.lain_lain || '-',
            keterangan: itemToDelete.keterangan || '-'
          }]);
          showToast('ï¿½ï¿½ï¿½ Data dihapus dari Canva Sheet & Google Sheets!', 'success');
        } catch (error) {
          showToast('âœ… Data dihapus dari Canva Sheet (Google Sheets error)', 'success');
        }
      } else {
        showToast('âŒ Gagal menghapus data.', 'error');
      }
      
      this.disabled = false;
      this.textContent = 'Ya, Hapus';
      document.getElementById('delete-item-modal').classList.add('hidden');
      itemToDelete = null;
    });

    // Save edit handler
    document.getElementById('save-edit-btn').addEventListener('click', async function() {
      if (!itemToEdit) return;
      
      const updatedRecord = {
        ...itemToEdit,
        tanggal: document.getElementById('edit-tanggal').value,
        nik: document.getElementById('edit-nik').value,
        nama: document.getElementById('edit-nama').value,
        kesalahan_tulis: document.getElementById('edit-kesalahan-tulis').value,
        lain_lain: document.getElementById('edit-lain-lain').value,
        keterangan: document.getElementById('edit-keterangan').value
      };
      
      this.disabled = true;
      this.innerHTML = '<span class="animate-spin">ğŸ’«</span> Menyimpan...';
      
      const result = await window.dataSdk.update(updatedRecord);
      
      this.disabled = false;
      this.innerHTML = 'ğŸ’¾ Simpan Perubahan';
      document.getElementById('edit-modal').classList.add('hidden');
      
      if (result.isOk) {
        showToast('Data berhasil diperbarui!', 'success');
      } else {
        showToast('Gagal memperbarui data.', 'error');
      }
      
      itemToEdit = null;
    });

    document.getElementById('cancel-reset').addEventListener('click', function() {
      document.getElementById('confirm-modal').classList.add('hidden');
    });

    document.getElementById('confirm-reset').addEventListener('click', async function() {
      this.disabled = true;
      this.textContent = 'Menghapus...';
      
      for (const item of errorData) {
        await window.dataSdk.delete(item);
      }
      
      // Delete semua dari Google Sheets
      deleteAllFromGoogleSheets();
      uploadedDataIds.clear();
      
      this.disabled = false;
      this.textContent = 'Ya, Hapus Semua';
      document.getElementById('confirm-modal').classList.add('hidden');
      
      showToast('Semua data berhasil dihapus dari Canva & Google Sheets!', 'success');
    });

    // Security Code Handlers
    document.getElementById('cancel-security').addEventListener('click', function() {
      document.getElementById('security-modal').classList.add('hidden');
      pendingAction = null;
      itemToDelete = null;
    });

    document.getElementById('verify-security').addEventListener('click', function() {
      const code = document.getElementById('security-code-input').value;
      const errorEl = document.getElementById('security-error');
      
      if (code === SECURITY_CODE) {
        errorEl.classList.add('hidden');
        document.getElementById('security-modal').classList.add('hidden');
        
        // Proceed with pending action
        if (pendingAction === 'reset') {
          document.getElementById('confirm-modal').classList.remove('hidden');
        } else if (pendingAction === 'delete-item') {
          document.getElementById('delete-item-modal').classList.remove('hidden');
        } else if (pendingAction === 'edit-item') {
          // Open edit modal with data
          document.getElementById('edit-tanggal').value = itemToEdit.tanggal;
          document.getElementById('edit-nik').value = itemToEdit.nik || '';
          document.getElementById('edit-nama').value = itemToEdit.nama || '';
          document.getElementById('edit-kesalahan-tulis').value = itemToEdit.kesalahan_tulis || '';
          document.getElementById('edit-lain-lain').value = itemToEdit.lain_lain || '';
          document.getElementById('edit-keterangan').value = itemToEdit.keterangan || '';
          document.getElementById('edit-modal').classList.remove('hidden');
        }
        
        pendingAction = null;
      } else {
        errorEl.classList.remove('hidden');
        document.getElementById('security-code-input').value = '';
        document.getElementById('security-code-input').focus();
      }
    });

    // Allow Enter key to verify
    document.getElementById('security-code-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('verify-security').click();
      }
    });

    // Helper functions untuk Google Sheets
    async function uploadToGoogleSheets(dataArray) {
      try {
        // Gunakan semua data, tidak perlu filter
        if (dataArray.length === 0) {
          showToast('Tidak ada data untuk dikirim.', 'error');
          return;
        }
        
        // Sort by date ascending (earliest first) dan add row numbers dengan nomor urut yang benar
        const sortedData = getSortedData(dataArray).map((item, index) => ({
          no: index + 1,
          backendId: item.__backendId,
          tanggal: item.tanggal,
          nik: item.nik || '-',
          nama: item.nama || '-',
          kesalahan_tulis: item.kesalahan_tulis || '-',
          lain_lain: item.lain_lain || '-',
          keterangan: item.keterangan || '-'
        }));

        const payload = {
          action: 'create',
          data: sortedData
        };

        console.log('ï¿½ï¿½ï¿½ï¿½ Mengirim ke Google Sheets:', payload);

        const response = await fetch(GOOGLE_SHEETS_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          mode: 'no-cors'
        });

        console.log('âœ… Response status:', response.status);
        
        // Tandai data yang dikirim
        dataArray.forEach(item => {
          uploadedDataIds.add(item.__backendId);
        });
        
        return true;
      } catch (error) {
        console.error('âŒ Error uploading to Google Sheets:', error);
        throw error;
      }
    }

    async function deleteFromGoogleSheets(dataArray) {
      try {
        // Log data yang akan dihapus
        console.log('ğŸ“Œ Data to delete from Google Sheets:');
        dataArray.forEach((item, idx) => {
          console.log(`Item ${idx + 1}:`, {
            backendId: item.backendId || item.__backendId,
            tanggal: item.tanggal,
            nik: item.nik,
            nama: item.nama,
            kesalahan_tulis: item.kesalahan_tulis,
            lain_lain: item.lain_lain,
            keterangan: item.keterangan
          });
        });
        
        // Kirim data LENGKAP untuk pencocokan di Google Sheets
        const payload = {
          action: 'delete',
          data: dataArray.map(item => ({
            backendId: item.backendId || item.__backendId,
            tanggal: item.tanggal,
            nik: item.nik || '-',
            nama: item.nama || '-',
            kesalahan_tulis: item.kesalahan_tulis || '-',
            lain_lain: item.lain_lain || '-',
            keterangan: item.keterangan || '-'
          }))
        };

        console.log('ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Full delete payload being sent:', JSON.stringify(payload, null, 2));
        
        const response = await fetch(GOOGLE_SHEETS_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        const result = await response.text();
        console.log('âœ… Delete response from Google Sheets:', result);
        
        // Hapus dari tracking setelah berhasil
        dataArray.forEach(item => {
          uploadedDataIds.delete(item.backendId || item.__backendId);
        });
      } catch (error) {
        console.error('âŒ Error deleting from Google Sheets:', error);
        showToast('Gagal menghapus dari Google Sheets, tapi data Canva berhasil dihapus.', 'error');
      }
    }

    async function deleteAllFromGoogleSheets() {
      try {
        const payload = {
          action: 'deleteAll'
        };

        const response = await fetch(GOOGLE_SHEETS_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        const result = await response.text();
        console.log('Delete all result:', result);
      } catch (error) {
        console.error('Error deleting all from Google Sheets:', error);
      }
    }

    // Refresh data dari Google Sheets
    async function refreshDataFromGoogleSheets() {
      try {
        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<span class="animate-spin">ï¿½ï¿½ï¿½</span> Memproses...';

        console.log('ï¿½ï¿½ Mulai refresh data dari Google Sheets...');

        const payload = {
          action: 'read'
        };

        const response = await fetch(GOOGLE_SHEETS_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          mode: 'no-cors'
        });

        console.log('ğŸ“¡ Response status:', response.status);
        console.log('ğŸ“¡ Response type:', response.type);

        // Dengan mode: no-cors, kita tidak bisa read response body
        // Jadi kita asumsikan berhasil dan buat toast
        showToast('âœ… Permintaan refresh dikirim ke Google Sheets. Data akan diperbarui.', 'success');
        
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<span>ğŸ”„</span> Refresh Data';
        
        console.log('âœ… Refresh request berhasil dikirim');
      } catch (error) {
        console.error('âŒ Error refreshing data:', error);
        showToast('âš ï¸ Gagal mengirim permintaan refresh. Pastikan Google Sheets API terhubung.', 'error');
        
        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<span>ğŸ”„</span> Refresh Data';
      }
    }

    // Send to Google Sheets
    document.getElementById('confirm-send').addEventListener('click', async function() {
      this.disabled = true;
      this.textContent = 'Mengirim...';

      try {
        // Filter hanya data baru yang belum dikirim
        const newData = errorData.filter(item => !uploadedDataIds.has(item.__backendId));
        const success = await uploadToGoogleSheets(newData);
        
        if (success) {
          this.disabled = false;
          this.textContent = 'Ya, Buka Google Sheets';
          document.getElementById('send-modal').classList.add('hidden');
          showToast('âœ… Data baru berhasil dikirim ke Google Sheets!', 'success');
        }
      } catch (error) {
        console.error('âŒ Error:', error);
        showToast('âš ï¸ Terjadi kesalahan saat mengirim. Periksa console untuk detail.', 'error');
        this.disabled = false;
        this.textContent = 'Ya, Buka Google Sheets';
      }
    });

    document.getElementById('cancel-send').addEventListener('click', function() {
      document.getElementById('send-modal').classList.add('hidden');
    });

    // Reset button handler
    document.getElementById('reset-btn').addEventListener('click', function() {
      pendingAction = 'reset';
      document.getElementById('security-code-input').value = '';
      document.getElementById('security-error').classList.add('hidden');
      document.getElementById('security-modal').classList.remove('hidden');
    });

    // Refresh confirmation modal
    const refreshConfirmModal = document.createElement('div');
    refreshConfirmModal.id = 'refresh-confirm-modal';
    refreshConfirmModal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    refreshConfirmModal.innerHTML = `
      <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-slate-800 mb-2">ğŸ”„ Konfirmasi Refresh</h3>
        <p class="text-slate-600 mb-4">Refresh akan menghapus data lokal dan memuat ulang dari Google Sheets. Lanjutkan?</p>
        <div class="flex gap-3 justify-end">
          <button type="button" id="cancel-refresh" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-xl transition-all">
            Batal
          </button>
          <button type="button" id="confirm-refresh" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-xl transition-all">
            Ya, Refresh
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(refreshConfirmModal);

    document.getElementById('cancel-refresh').addEventListener('click', function() {
      document.getElementById('refresh-confirm-modal').classList.add('hidden');
    });

    document.getElementById('confirm-refresh').addEventListener('click', async function() {
      document.getElementById('refresh-confirm-modal').classList.add('hidden');
      await refreshDataFromGoogleSheets();
    });

    // Refresh button handler
    document.getElementById('refresh-btn').addEventListener('click', function() {
      const refreshBtn = this;
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<span class="animate-spin">ğŸ”„</span> Memproses...';

      // STEP 1: Hapus SEMUA data dari Google Sheets
      deleteAllFromGoogleSheets().then(() => {
        // Tunggu 500ms
        setTimeout(() => {
          // STEP 2: Kirim data Canva ke Google Sheets
          if (errorData.length > 0) {
            uploadToGoogleSheets(errorData).then(() => {
              showToast(`âœ… Refresh berhasil! ${errorData.length} data tersinkronisasi.`, 'success');
              refreshBtn.disabled = false;
              refreshBtn.innerHTML = '<span>ğŸ”„</span> Refresh Data';
            }).catch(err => {
              console.error('Error uploading:', err);
              showToast('âš ï¸ Gagal upload data. Silakan coba lagi.', 'error');
              refreshBtn.disabled = false;
              refreshBtn.innerHTML = '<span>ğŸ”„</span> Refresh Data';
            });
          } else {
            showToast('âœ… Refresh berhasil! Data Canva kosong dan Google Sheet sudah dibersihkan.', 'success');
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<span>ï¿½ï¿½ï¿½</span> Refresh Data';
          }
        }, 500);
      }).catch(err => {
        console.error('Error deleting all:', err);
        showToast('âš ï¸ Gagal menghapus data lama. Silakan coba lagi.', 'error');
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<span>ğŸ”„</span> Refresh Data';
      });
    });

    // Send button handler
    document.getElementById('send-btn').addEventListener('click', function() {
      const newDataCount = errorData.filter(item => !uploadedDataIds.has(item.__backendId)).length;
      
      if (newDataCount === 0) {
        showToast('Semua data sudah dikirim. Tidak ada data baru.', 'info');
        return;
      }
      
      // Clear browser's saved password
      if (navigator.credentials) {
        navigator.credentials.preventSilentAccess();
      }
      pendingAction = 'send';
      document.getElementById('send-modal-msg').textContent = `Kirim ${newDataCount} data baru ke Google Sheets?`;
      document.getElementById('send-modal').classList.remove('hidden');
    });

    // Toast notification
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast-notification fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 flex items-center gap-2 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
      }`;
      toast.innerHTML = `
        <span>${type === 'success' ? 'ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½' : 'ï¿½ï¿½'}</span>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // Data handler - filter error data dan employee data
    const dataHandler = {
      onDataChanged(data) {
        // Pisahkan employee dari error data
        const employeeRecords = data.filter(item => item.type === 'employee');
        const errorRecords = data.filter(item => !item.type || item.type !== 'employee');
        
        // STEP 1: Mulai dengan default employees
        employees = [...defaultEmployees];
        deletedDefaultEmployees = loadDeletedEmployees();
        
        // STEP 2: Filter out deleted default employees
        employees = employees.filter(emp => 
          !deletedDefaultEmployees.includes(emp.nik)
        );
        
        // STEP 3: Tambah semua employee records dari Canva Sheet
        employeeRecords.forEach(emp => {
          if (!employees.find(e => e.nik === emp.nik)) {
            employees.push({
              nik: emp.nik,
              nama: emp.nama
            });
          }
        });
        
        // Update error data
        errorData = errorRecords;
        
        // Update UI
        populateNikDropdown();
        renderEmployeesList();
        renderTable();
      }
    };

    // Element SDK config
    const elementHandler = {
      defaultConfig,
      onConfigChange: async (config) => {
        const title = config.app_title || defaultConfig.app_title;
        document.getElementById('app-title').textContent = title;
      },
      mapToCapabilities: (config) => ({
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (config) => new Map([
        ["app_title", config.app_title || defaultConfig.app_title]
      ])
    };

    // Initialize
    async function init() {
      initLogin();
      
      document.getElementById('tanggal').valueAsDate = new Date();
      
      // Load custom employees dari localStorage
      const customEmps = loadCustomEmployees();
      employees = [...defaultEmployees, ...customEmps];
      deletedDefaultEmployees = loadDeletedEmployees();
      
      // Filter out deleted default employees
      employees = employees.filter(emp => 
        !deletedDefaultEmployees.includes(emp.nik)
      );
      
      populateNikDropdown();
      renderEmployeesList();
      
      if (window.elementSdk) {
        window.elementSdk.init(elementHandler);
      }
      
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          showToast('Gagal menghubungkan ke database.', 'error');
        }
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cdd8d64a2293fb8',t:'MTc3MTA4MjQ1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
